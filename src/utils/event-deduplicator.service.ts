import { Context } from '@maxhub/max-bot-api';
import { Injectable } from '@nestjs/common';

/**
 * Сервис для дедупликации событий (предотвращения повторной обработки идентичных событий).
 *
 * Предназначен для использования в ботах, где платформа может дублировать события
 * (например, при добавлении бота в чат).
 *
 * @remarks
 * - Использует внутреннее хранилище обработанных ключей (`Set<string>`).
 * - Ключи автоматически удаляются по истечении TTL (time‑to‑live).
 * - Оптимизирован для работы в асинхронной среде.
 */
@Injectable()
export class EventDeduplicatorService {
  private processed = new Set<string>();

  /**
   * Формирует уникальный ключ события на основе контекста.
   *
   * Ключ состоит из объединённых значений chatId и userId, что позволяет:
   * - идентифицировать событие в контексте конкретного чата и пользователя;
   * - предотвращать дублирование обработки одинаковых событий.
   *
   * @param ctx - Контекст события (сообщения, callback и т.п.)
   * @returns Строку-ключ в формате `${normalizedChatId}_${userId}` или `null`,
   *          если обязательные поля отсутствуют или некорректны
   *
   * @example
   *   // Для ctx с chatId=123 и user.user_id=456 вернёт "123_456"
   *   // Если chatId — объект с chat_id=789, вернёт "789_456"
   *   // Если userId отсутствует, вернёт null
   */
  getKey(ctx: Context): null | string {
    // баг только при добавлении бота
    if (ctx.update.update_type !== 'bot_added') return null;
    const chatId = ctx.chatId;
    const userId = ctx.user?.user_id;

    if (!chatId || !userId) {
      return null;
    }

    return `${chatId}_${userId}`;
  }

  /**
   * Проверяет, является ли событие дубликатом, и управляет временем жизни ключа.
   *
   * Алгоритм работы:
   * 1. Проверяет наличие ключа в наборе `processed`.
   * 2. Если ключ найден — возвращает `true` (событие уже обрабатывалось).
   * 3. Если ключа нет — добавляет его в набор и устанавливает таймер на удаление
   *    через указанное время (`ttl`).
   * 4. Возвращает `false` (событие новое, обработка разрешена).
   *
   * @param key - Уникальный ключ события, который должен быть получен
   *   посредством вызова метода `getKey()`.
   *   Если передан некорректный или пустой ключ, поведение метода не гарантировано.
   * @param ttl - Время жизни ключа в миллисекундах, в течение которого ключ
   *   считается актуальным (по умолчанию — 5000 мс, т. е. 5 секунд).
   *   После истечения этого времени ключ автоматически удаляется из хранилища.
   * @returns
   *   - `true`, если ключ уже присутствует в наборе `processed`
   *     (событие считается дубликатом и не требует повторной обработки).
   *   - `false`, если ключа не было в наборе (событие новое, можно обрабатывать).
   *
   * @example
   * ```typescript
   * const key = deduplicator.getKey(ctx);
   * if (deduplicator.isDuplicate(key)) {
   *   return; // Игнорируем дубликат
   * }
   * // Обрабатываем событие
   * ```
   */
  isDuplicate(key: string, ttl = 5000): boolean {
    if (this.processed.has(key)) return true;

    this.processed.add(key);
    setTimeout(() => this.processed.delete(key), ttl);
    return false;
  }
}
